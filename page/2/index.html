<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 2 页 | Moon&#39;s blog | write the code, change the world.</title>

  
  <meta name="author" content="Moon">
  

  
  <meta name="description" content="Ruby\Golang">
  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="Moon&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Moon&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

  <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?a9ab16fc25a6e74e9e3521e7ad3782e8";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
  </script>
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Moon&#39;s blog</a>
    </h1>
    <p class="site-description">write the code, change the world.</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/tags">标签</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2016/12/05/MySQL查询优化/"><span>MySQL查询优化</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/12/05/MySQL查询优化/" rel="bookmark">
        <time class="entry-date published" datetime="2016-12-05T01:47:41.000Z">
          2016-12-05
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>2017.12.11更新<br><a href="https://www.youtube.com/watch?v=BuDWWadCqIw" target="_blank" rel="noopener">The Secret Life of SQL: How to Optimize Database Performance by Bryana Knight</a></p>
<h3 id="查询性能低下的原因是访问了太多的数据"><a href="#查询性能低下的原因是访问了太多的数据" class="headerlink" title="查询性能低下的原因是访问了太多的数据"></a>查询性能低下的原因是访问了太多的数据</h3><ul>
<li>多表连接时返回了所有的列</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select * from sakila.actor </span><br><span class="line">inner join sakila.file_actor using(actior_id)</span><br><span class="line">inner join sakila.film using(film_id)</span><br><span class="line">where sakila.film.title = &apos;AronMan&apos;</span><br></pre></td></tr></table></figure>
<font color="red">正确的做法是这样</font>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select sakila.actor.* from sakila.actor </span><br><span class="line">inner join sakila.file_actor using(actior_id)</span><br><span class="line">inner join sakila.film using(film_id)</span><br><span class="line">where sakila.film.title = &apos;AronMan&apos;</span><br></pre></td></tr></table></figure>
<ul>
<li>分解连接技术</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select * from tag</span><br><span class="line">join tag_post on tag_post.tag_id=tag.id</span><br><span class="line">join post on tag_post.post_id=post.id</span><br><span class="line">where tag.tag=&apos;mysql&apos;</span><br></pre></td></tr></table></figure>
<p>分解连接之后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from tag where tag=&apos;mysql&apos;</span><br><span class="line">select * from tag_post where tag_id=1234</span><br><span class="line">select * from post where post.id in(123,456,789)</span><br></pre></td></tr></table></figure>
<p>分解连接看上去比较浪费，但是有巨大优势</p>
<ol>
<li>缓存效率高</li>
<li>MyISAM引擎下，锁住表的时间短</li>
<li>在应用程序端连接可以更方便扩展数据库，把表放在不同的数据库服务器上</li>
<li>查询本身更高效</li>
<li>减少多余行的访问</li>
</ol>
<p><strong>什么时候使用分解连接？</strong></p>
<ol>
<li>可以缓存大量查询</li>
<li>使用了多个MyISAM表</li>
<li>数据分布在不同服务器</li>
<li>对于大表使用in替换连接</li>
<li>一个连接引用了同一个表多次</li>
</ol>
<h3 id="优化连接"><a href="#优化连接" class="headerlink" title="优化连接"></a>优化连接</h3><ol>
<li>确保on或者using的列有索引</li>
<li>确保group by 或者order by只引用一个列，这样可以使用索引</li>
</ol>
<h3 id="悲观锁"><a href="#悲观锁" class="headerlink" title="悲观锁"></a>悲观锁</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select chairid from seat where booked is null for update</span><br><span class="line">update seat set booked=&apos;x&apos; where chairid=1</span><br><span class="line">commit</span><br></pre></td></tr></table></figure>
<h2 id="索引及查询优化"><a href="#索引及查询优化" class="headerlink" title="索引及查询优化"></a>索引及查询优化</h2><p>摘取部分自<a href="http://blog.chinaunix.net/uid-11640640-id-3426908.html" target="_blank" rel="noopener">mysql性能优化-慢查询分析、优化索引和配置 </a></p>
<h3 id="索引的类型"><a href="#索引的类型" class="headerlink" title="索引的类型"></a>索引的类型</h3><p>Ø 普通索引：这是最基本的索引类型，没唯一性之类的限制。</p>
<p>Ø 唯一性索引：和普通索引基本相同，但所有的索引列值保持唯一性。</p>
<p>Ø 主键：主键是一种唯一索引，但必须指定为”PRIMARY KEY”。</p>
<p>Ø 全文索引：MYSQL从3.23.23开始支持全文索引和全文检索。在MYSQL中，全文索引的索引类型为FULLTEXT。全文索引可以在VARCHAR或者TEXT类型的列上创建。</p>
<p>使用多列索引 要注意最左前缀问题</p>
<p>有时MySQL不使用索引，即使有可用的索引。一种情形是当优化器估计到使用索引将需要MySQL访问表中的大部分行时。(在这种情况下，表扫描可能会更快些）。然而，如果此类查询使用LIMIT只搜索部分行，MySQL则使用索引，因为它可以更快地找到几行并在结果中返回。</p>
<h3 id="合理的建立索引的建议："><a href="#合理的建立索引的建议：" class="headerlink" title="合理的建立索引的建议："></a>合理的建立索引的建议：</h3><p>(1)  越小的数据类型通常更好：越小的数据类型通常在磁盘、内存和CPU缓存中都需要更少的空间，处理起来更快。 </p>
<p>(2)  简单的数据类型更好：整型数据比起字符，处理开销更小，因为字符串的比较更复杂。在MySQL中，应该用内置的日期和时间数据类型，而不是用字符串来存储时间；以及用整型数据类型存储IP地址。</p>
<p>(3)  尽量避免NULL：应该指定列为NOT NULL，除非你想存储NULL。在MySQL中，含有空值的列很难进行查询优化，因为它们使得索引、索引的统计信息以及比较运算更加复杂。你应该用0、一个特殊的值或者一个空串代替空值</p>
<h3 id="这部分是关于索引和写SQL语句时应当注意的一些琐碎建议和注意点。"><a href="#这部分是关于索引和写SQL语句时应当注意的一些琐碎建议和注意点。" class="headerlink" title="这部分是关于索引和写SQL语句时应当注意的一些琐碎建议和注意点。"></a>这部分是关于索引和写SQL语句时应当注意的一些琐碎建议和注意点。</h3><ol>
<li><p>当结果集只有一行数据时使用LIMIT 1</p>
</li>
<li><p>避免SELECT *，始终指定你需要的列</p>
</li>
</ol>
<p>从表中读取越多的数据，查询会变得更慢。他增加了磁盘需要操作的时间，还是在数据库服务器与WEB服务器是独立分开的情况下。你将会经历非常漫长的网络延迟，仅仅是因为数据不必要的在服务器之间传输。</p>
<ol>
<li><p>使用连接（JOIN）来代替子查询(Sub-Queries)。 连接（JOIN）之所以更有效率一些，是因为MySQL不需要在内存中创建临时表来完成这个逻辑上的需要两个步骤的查询工作。</p>
</li>
<li><p>使用ENUM、CHAR 而不是VARCHAR，使用合理的字段属性长度</p>
</li>
<li><p>尽可能的使用NOT NULL</p>
</li>
<li><p>固定长度的表会更快</p>
</li>
<li><p>拆分大的DELETE 或INSERT 语句</p>
</li>
<li><p>查询的列越小越快</p>
</li>
</ol>
<h3 id="Where条件"><a href="#Where条件" class="headerlink" title="Where条件"></a>Where条件</h3><p>在查询中，WHERE条件也是一个比较重要的因素，尽量少并且是合理的where条件是很重要的，尽量在多个条件的时候，把会提取尽量少数据量的条件放在前面，减少后一个where条件的查询时间。</p>
<p>有些where条件会导致索引无效：</p>
<p>Ø where子句的查询条件里有！=，MySQL将无法使用索引。</p>
<p>Ø where子句使用了Mysql函数的时候，索引将无效，比如：select * from tb where left(name, 4) = ‘xxx’</p>
<p>Ø 使用LIKE进行搜索匹配的时候，这样索引是有效的：select * from tbl1 where name like ‘xxx%’，而like ‘%xxx%’ 时索引无效</p>
<h2 id="技巧整理"><a href="#技巧整理" class="headerlink" title="技巧整理"></a>技巧整理</h2><p>1、应尽量避免在 where 子句中使用!=或&lt;&gt;操作符，否则将引擎放弃使用索引而进行全表扫描。</p>
<p>2、对查询进行优化，应尽量避免全表扫描，首先应考虑在 where 及 order by 涉及的列上建立索引。</p>
<p>3、应尽量避免在 where 子句中对字段进行 null 值判断，否则将导致引擎放弃使用索引而进行全表扫描，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where num is null</span><br></pre></td></tr></table></figure>
<p>可以在num上设置默认值0，确保表中num列没有null值，然后这样查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where num=0</span><br></pre></td></tr></table></figure>
<p>4、尽量避免在 where 子句中使用 or 来连接条件，否则将导致引擎放弃使用索引而进行全表扫描，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where num=10 or num=20</span><br></pre></td></tr></table></figure>
<p>可以这样查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select id from t where num=10</span><br><span class="line">union all</span><br><span class="line">select id from t where num=20</span><br></pre></td></tr></table></figure>
<p>5、下面的查询也将导致全表扫描：(不能前置百分号)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where name like &apos;%abc&apos;</span><br></pre></td></tr></table></figure>
<p>若要提高效率，可以考虑全文检索。</p>
<p>6、in 和 not in 也要慎用，否则会导致全表扫描，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where num in(1,2,3)</span><br></pre></td></tr></table></figure>
<p>对于连续的数值，能用 between 就不要用 in 了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where num between 1 and 3</span><br></pre></td></tr></table></figure>
<p>7、如果在 where 子句中使用参数，也会导致全表扫描。因为SQL只有在运行时才会解析局部变量，但优化程序不能将访问计划的选择推迟到运行时；它必须在编译时进行选择。然 而，如果在编译时建立访问计划，变量的值还是未知的，因而无法作为索引选择的输入项。如下面语句将进行全表扫描：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where num=@num</span><br></pre></td></tr></table></figure>
<p>可以改为强制查询使用索引：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t with(index(索引名)) where num=@num</span><br></pre></td></tr></table></figure>
<p>8、应尽量避免在 where 子句中对字段进行表达式操作，这将导致引擎放弃使用索引而进行全表扫描。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where num/2=100</span><br></pre></td></tr></table></figure>
<p>应改为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where num=100*2</span><br></pre></td></tr></table></figure>
<p>9、应尽量避免在where子句中对字段进行函数操作，这将导致引擎放弃使用索引而进行全表扫描。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where substring(name,1,3)=’abc’</span><br></pre></td></tr></table></figure>
<p>应改为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select id from t where name like ‘abc%’</span><br><span class="line">select id from t where createdate&gt;=’2005-11-30′ and createdate&lt;’2005-12-1′</span><br></pre></td></tr></table></figure>
<p>10、不要在 where 子句中的“=”左边进行函数、算术运算或其他表达式运算，否则系统将可能无法正确使用索引。</p>
<p>11、在使用索引字段作为条件时，如果该索引是复合索引，那么必须使用到该索引中的第一个字段作为条件时才能保证系统使用该索引，否则该索引将不会被使 用，并且应尽可能的让字段顺序与索引顺序相一致。</p>
<p>12、不要写一些没有意义的查询，如需要生成一个空表结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select col1,col2 into #t from t where 1=0</span><br></pre></td></tr></table></figure>
<p>这类代码不会返回任何结果集，但是会消耗系统资源的，应改成这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create table #t(…)</span><br></pre></td></tr></table></figure>
<p>13、很多时候用 exists 代替 in 是一个好的选择：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select num from a where num in(select num from b)</span><br></pre></td></tr></table></figure>
<p>用下面的语句替换：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select num from a where exists(select 1 from b where num=a.num)</span><br></pre></td></tr></table></figure>
<p>14、并不是所有索引对查询都有效，SQL是根据表中数据来进行查询优化的，当索引列有大量数据重复时，SQL查询可能不会去利用索引，如一表中有字段 sex，male、female几乎各一半，那么即使在sex上建了索引也对查询效率起不了作用。</p>
<p>15、索引并不是越多越好，索引固然可以提高相应的 select 的效率，但同时也降低了 insert 及 update 的效率，因为 insert 或 update 时有可能会重建索引，所以怎样建索引需要慎重考虑，视具体情况而定。一个表的索引数最好不要超过6个，若太多则应考虑一些不常使用到的列上建的索引是否有 必要。</p>
<p>16.应尽可能的避免更新 clustered 索引数据列，因为 clustered 索引数据列的顺序就是表记录的物理存储顺序，一旦该列值改变将导致整个表记录的顺序的调整，会耗费相当大的资源。若应用系统需要频繁更新 clustered 索引数据列，那么需要考虑是否应将该索引建为 clustered 索引。</p>
<p>17、尽量使用数字型字段，若只含数值信息的字段尽量不要设计为字符型，这会降低查询和连接的性能，并会增加存储开销。这是因为引擎在处理查询和连接时会 逐个比较字符串中每一个字符，而对于数字型而言只需要比较一次就够了。</p>
<p>18、尽可能的使用 varchar/nvarchar 代替 char/nchar ，因为首先变长字段存储空间小，可以节省存储空间，其次对于查询来说，在一个相对较小的字段内搜索效率显然要高些。</p>
<p>19、任何地方都不要使用 select <em> from t ，用具体的字段列表代替“</em>”，不要返回用不到的任何字段。</p>
<p>20、尽量使用表变量来代替临时表。如果表变量包含大量数据，请注意索引非常有限（只有主键索引）。</p>
<p>21、避免频繁创建和删除临时表，以减少系统表资源的消耗。</p>
<p>22、临时表并不是不可使用，适当地使用它们可以使某些例程更有效，例如，当需要重复引用大型表或常用表中的某个数据集时。但是，对于一次性事件，最好使 用导出表。</p>
<p>23、在新建临时表时，如果一次性插入数据量很大，那么可以使用 select into 代替 create table，避免造成大量 log ，以提高速度；如果数据量不大，为了缓和系统表的资源，应先create table，然后insert。</p>
<p>24、如果使用到了临时表，在存储过程的最后务必将所有的临时表显式删除，先 truncate table ，然后 drop table ，这样可以避免系统表的较长时间锁定。</p>
<p>25、尽量避免使用游标，因为游标的效率较差，如果游标操作的数据超过1万行，那么就应该考虑改写。</p>
<p>26、使用基于游标的方法或临时表方法之前，应先寻找基于集的解决方案来解决问题，基于集的方法通常更有效。</p>
<p>27、与临时表一样，游标并不是不可使用。对小型数据集使用 FAST_FORWARD 游标通常要优于其他逐行处理方法，尤其是在必须引用几个表才能获得所需的数据时。在结果集中包括“合计”的例程通常要比使用游标执行的速度快。如果开发时 间允许，基于游标的方法和基于集的方法都可以尝试一下，看哪一种方法的效果更好。</p>
<p>28、在所有的存储过程和触发器的开始处设置 SET NOCOUNT ON ，在结束时设置 SET NOCOUNT OFF 。无需在执行存储过程和触发器的每个语句后向客户端发送 DONE_IN_PROC 消息。</p>
<p>29、尽量避免向客户端返回大数据量，若数据量过大，应该考虑相应需求是否合理。</p>
<p>30、尽量避免大事务操作，提高系统并发能力。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/后端/">后端</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/12/05/MySQL查询优化/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/10/05/使用mina自动化部署Rails应用/"><span>使用mina自动化部署Rails应用</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/10/05/使用mina自动化部署Rails应用/" rel="bookmark">
        <time class="entry-date published" datetime="2016-10-05T01:41:57.000Z">
          2016-10-05
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p><img src="http://upload-images.jianshu.io/upload_images/4073552-1881d52edbf495e0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>为什么需要自动化部署？</p>
<h4 id="因为我懒啊！！！"><a href="#因为我懒啊！！！" class="headerlink" title="因为我懒啊！！！"></a>因为我懒啊！！！</h4><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>mina是rails社区中流行的部署方案，允许你用Ruby DSL描述部署过程，mina生成一份脚本在目标服务器上执行。除了Ruby以外，也支持shell脚本，所以可定制性非常高。相比于老牌的Capstrino，mina一次性上传所有脚本到目标服务器执行，效率上会高一些。</p>
<h4 id="核心步骤与原理"><a href="#核心步骤与原理" class="headerlink" title="核心步骤与原理"></a>核心步骤与原理</h4><p>mina setup生成目标服务器上的文件夹结构</p>
<p>mina deploy进行部署</p>
<p>mina会自动从设置好的git仓库拉代码，运行bundle／migration等一系列流程，然后重启服务器</p>
<h4 id="简单对比"><a href="#简单对比" class="headerlink" title="简单对比"></a>简单对比</h4><p>手动部署</p>
<ol>
<li><p>git pull</p>
</li>
<li><p>bundle  install</p>
</li>
<li><p>rake db：migrate</p>
</li>
<li><p>rake assets：precompile</p>
</li>
<li><p>restart web server</p>
</li>
</ol>
<p>自动部署</p>
<ol>
<li>mina deploy</li>
</ol>
<p>一条命令就可以跑完整个发布流程。当然前提是你的deploy task写的天衣无缝，这需要对rails与linux有一定了解才可以做到。</p>
<h4 id="举个栗子"><a href="#举个栗子" class="headerlink" title="举个栗子"></a>举个栗子</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">require <span class="string">'mina/bundler'</span></span><br><span class="line"></span><br><span class="line">require <span class="string">'mina/rails'</span></span><br><span class="line"></span><br><span class="line">require <span class="string">'mina/git'</span></span><br><span class="line"></span><br><span class="line">require <span class="string">'mina/rvm'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> :domain, <span class="string">'121.42.12.xx'</span> ＃你的服务器地址或域名</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> :deploy_to, <span class="string">'/var/www/api'</span> ＃你打算把项目部署在服务器的哪个文件夹</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> :repository, <span class="string">'git@github.com:xxx.git'</span> ＃git仓库</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> :branch, <span class="string">'master'</span> ＃git分支</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> :term_mode, nil  ＃mina的小bug，设为nil可以解决</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> :shared_paths, [<span class="string">'config/sidekiq.yml'</span>, <span class="string">'config/database.yml'</span>, <span class="string">'config/secrets.yml'</span>, <span class="string">'log'</span>, <span class="string">'shared'</span>] ＃很关键，这几个文件夹会在多次部署间，通过符号链接的形式共享</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> :user, <span class="string">'moon'</span> ＃ssh 用户名</span><br><span class="line"></span><br><span class="line">task :environment <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">invoke :<span class="string">'rvm:use[ruby-2.1.0-p0@default]'</span> ＃ruby 版本</span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">task :setup =&gt; :environment <span class="keyword">do</span>  ＃初始化task，创建文件夹结构</span><br><span class="line"></span><br><span class="line">queue! %[mkdir -p <span class="string">"#&#123;deploy_to&#125;/#&#123;shared_path&#125;/log"</span>]</span><br><span class="line"></span><br><span class="line">queue! %[chmod g+rx,u+rwx <span class="string">"#&#123;deploy_to&#125;/#&#123;shared_path&#125;/log"</span>]</span><br><span class="line"></span><br><span class="line">queue! %[mkdir -p <span class="string">"#&#123;deploy_to&#125;/#&#123;shared_path&#125;/config"</span>]</span><br><span class="line"></span><br><span class="line">queue! %[chmod g+rx,u+rwx <span class="string">"#&#123;deploy_to&#125;/#&#123;shared_path&#125;/config"</span>]</span><br><span class="line"></span><br><span class="line">queue! %[mkdir -p <span class="string">"#&#123;deploy_to&#125;/#&#123;shared_path&#125;/shared"</span>]</span><br><span class="line"></span><br><span class="line">queue! %[chmod g+rx,u+rwx <span class="string">"#&#123;deploy_to&#125;/#&#123;shared_path&#125;/shared"</span>]</span><br><span class="line"></span><br><span class="line">queue! %[touch <span class="string">"#&#123;deploy_to&#125;/#&#123;shared_path&#125;/config/database.yml"</span>]</span><br><span class="line"></span><br><span class="line">queue! %[touch <span class="string">"#&#123;deploy_to&#125;/#&#123;shared_path&#125;/config/secrets.yml"</span>]</span><br><span class="line"></span><br><span class="line">queue  %[<span class="built_in">echo</span> <span class="string">"-----&gt; Be sure to edit '#&#123;deploy_to&#125;/#&#123;shared_path&#125;/config/database.yml' and 'secrets.yml'."</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> repository</span><br><span class="line"></span><br><span class="line">repo_host = repository.split(%r&#123;@|://&#125;).last.split(%r&#123;:|\/&#125;).first</span><br><span class="line"></span><br><span class="line">repo_port = /:([0-9]+)/.match(repository) &amp;&amp; /:([0-9]+)/.match(repository)[1] || <span class="string">'22'</span></span><br><span class="line"></span><br><span class="line">queue %[</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ! ssh-keygen -H  -F <span class="comment">#&#123;repo_host&#125; &amp;&gt;/dev/null; then</span></span><br><span class="line"></span><br><span class="line">ssh-keyscan -t rsa -p <span class="comment">#&#123;repo_port&#125; -H #&#123;repo_host&#125; &gt;&gt; ~/.ssh/known_hosts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">desc <span class="string">"Deploys the current version to the server."</span></span><br><span class="line"></span><br><span class="line">task :deploy =&gt; :environment <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">to :before_hook <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">deploy <span class="keyword">do</span> ＃部署流程</span><br><span class="line"></span><br><span class="line">invoke :<span class="string">'git:clone'</span></span><br><span class="line"></span><br><span class="line">invoke :<span class="string">'deploy:link_shared_paths'</span></span><br><span class="line"></span><br><span class="line">invoke :<span class="string">'bundle:install'</span></span><br><span class="line"></span><br><span class="line">invoke :<span class="string">'rails:db_migrate'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#invoke :'rails:assets_precompile'</span></span><br><span class="line"></span><br><span class="line">invoke :<span class="string">'deploy:cleanup'</span></span><br><span class="line"></span><br><span class="line">invoke :start</span><br><span class="line"></span><br><span class="line">to :launch <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">queue <span class="string">"mkdir -p #&#123;deploy_to&#125;/#&#123;current_path&#125;/tmp/"</span></span><br><span class="line"></span><br><span class="line">queue <span class="string">"touch #&#123;deploy_to&#125;/#&#123;current_path&#125;/tmp/restart.txt"</span></span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">desc <span class="string">"start puma &amp; sidekiq"</span></span><br><span class="line"></span><br><span class="line">task :start =&gt; :environment <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">queue <span class="string">"cd #&#123;deploy_to+"</span>/current<span class="string">"&#125;"</span></span><br><span class="line"></span><br><span class="line">queue <span class="string">"sidekiq -e production -d"</span></span><br><span class="line"></span><br><span class="line">queue <span class="string">"puma -e production"</span></span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/自动化部署/">自动化部署</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/10/05/使用mina自动化部署Rails应用/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/09/09/https理论与实践/"><span>https理论与实践</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/09/09/https理论与实践/" rel="bookmark">
        <time class="entry-date published" datetime="2016-09-09T01:46:06.000Z">
          2016-09-09
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>说点废话，我一直觉得APPLE是个非常激进的公司， 从早些的Flash，到现在的http，又比如新的Mac连USB口都不给。公司大到这个量级，已经可以凭一己之力促进先进技术的普及了。</p>
<h4 id="本文内容分为以下三部分"><a href="#本文内容分为以下三部分" class="headerlink" title="本文内容分为以下三部分"></a>本文内容分为以下三部分</h4><ul>
<li>HTTPS协议</li>
<li>使用Let’s Encrypt在后端部署https服务</li>
<li>https在iOS上的正确使用姿势</li>
</ul>
<h4 id="Part1-HTTPS协议"><a href="#Part1-HTTPS协议" class="headerlink" title="Part1 HTTPS协议"></a>Part1 HTTPS协议</h4><p>普通的HTTP请求，在通信双方建立了TCP连接之后，就可以进行了。而HTTPS则不同，在建立TCP连接之后，需要先进行SSL协议的握手过程，然后才是HTTP的通信。</p>
<p>SSL的握手过程如下图所示<br><img src="http://upload-images.jianshu.io/upload_images/4073552-0d43756862bec209.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>alice想要与bob进行https的通信，需要以下几步</p>
<ol>
<li>alice给出协议版本号、一个客户端生成的随机数（Client random），以及客户端支持的加密方法。</li>
<li>bob确认双方使用的加密方法，并给出数字证书（包含bob的公钥）、以及一个服务器生成的随机数（Server random）。</li>
<li>alice 确认数字证书（向CA确认）有效，然后生成一个新的随机数（Premaster secret），并使用数字证书中的公钥，加密这个随机数，发给鲍勃。</li>
<li>bob使用自己的私钥，获取爱丽丝发来的随机数（即Premaster secret）。</li>
<li>alice和bob根据约定的加密方法，使用前面的三个随机数，生成”对话密钥”（session key），用来加密接下来的整个对话过程。</li>
</ol>
<p>上述步骤的最终目的，是为了生成”对话密钥“，以后的通信都使用这个密钥进行对称加密（一般对称加解密的速度是比较快的）</p>
<p>那么看到这里，就又一个问题出现了。握手阶段的信息安全如何保障？</p>
<p>答案是无法保障。整个握手阶段，都是明文的。因此如果有第三方窃听了通信，他可以获得Client random、Server random以及加密后的Premaster secret。只要第三方无法破解Premaster secret的内容，那么通信就是安全的。</p>
<h4 id="Part2-使用Let’s-Encrypt在后端部署https服务"><a href="#Part2-使用Let’s-Encrypt在后端部署https服务" class="headerlink" title="Part2 使用Let’s Encrypt在后端部署https服务"></a>Part2 使用Let’s Encrypt在后端部署https服务</h4><p>可以参考这篇文章</p>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-16-04" target="_blank" rel="noopener">How To Secure Nginx with Let’s Encrypt on Ubuntu 16.04</a></p>
<p>大致步骤</p>
<ol>
<li>安装certbot客户端</li>
<li>配置服务器允许方案 /.well-known文件夹</li>
<li>sudo letsencrypt certonly -a webroot –webroot-path=/var/www/html -d example.com -d www.example.com 这个命令会生成你需要的证书等文件</li>
<li>配置Nginx ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;<br>ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;</li>
</ol>
<p>如果速度很慢多半是python的源被墙了，需要改一下pip配置。</p>
<p>Let’s Encrypt大法好，退沃通保平安！</p>
<h4 id="Part3-在iOS上使用自己颁发的HTTPS证书的正确姿势"><a href="#Part3-在iOS上使用自己颁发的HTTPS证书的正确姿势" class="headerlink" title="Part3 在iOS上使用自己颁发的HTTPS证书的正确姿势"></a>Part3 在iOS上使用自己颁发的HTTPS证书的正确姿势</h4><p>在开发环境，也需要进行HTTPS的话，需要对AFN进行两个设置：允许不合法的证书和不验证域名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AFHTTPSessionManager *manager = [[AFHTTPSessionManager alloc] initWithBaseURL:[NSURL URLWithString:[self host]]];</span><br><span class="line"></span><br><span class="line">manager.securityPolicy.allowInvalidCertificates = YES;</span><br><span class="line">manager.securityPolicy.validatesDomainName = NO;</span><br></pre></td></tr></table></figure>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/后端/">后端</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/09/09/https理论与实践/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/06/05/使用vagrant统一开发环境/"><span>使用vagrant统一开发环境</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/06/05/使用vagrant统一开发环境/" rel="bookmark">
        <time class="entry-date published" datetime="2016-06-05T01:33:33.000Z">
          2016-06-05
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p><img src="http://upload-images.jianshu.io/upload_images/4073552-7b078da0420f2533.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p><a href="https://www.vagrantup.com/" target="_blank" rel="noopener">vagrant</a>类似现在很流行的docker ，相比起docker打包依赖的方式，vagrant打包的是整个虚拟机。</p>
<h4 id="核心原理"><a href="#核心原理" class="headerlink" title="核心原理"></a>核心原理</h4><p>vagrant 会把你配置好的虚拟机打包成box， 通过一个Vagrantfile配置这个虚拟机的一些行为。 其他成员只要使用你的box，就可以获得统一的开发环境。</p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p>安装步骤略去不提，使用vagrant很简单</p>
<p>1.vagrant init 创建一个文件夹，然后cd到这个文件夹里</p>
<p>2.vagrant box add hashicorp/precise64 (这个命令会下载ubuntu12.04LTS，也可以从<a href="https://atlas.hashicorp.com/boxes/search" target="_blank" rel="noopener">这里</a>寻找可用的box)</p>
<p>3.编辑Vagrantfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Vagrant.configure(&quot;2&quot;) do |config|</span><br><span class="line">  config.vm.box = &quot;hashicorp/precise64&quot;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">注意！ 这里的box值必须与第二步add的值一致！</span><br></pre></td></tr></table></figure>
<p>4.vagrant up 启动虚拟机</p>
<p>5.vagrant ssh 登录（也可以手动ssh，注意端口是2222,例如 ssh abc@192.168.1.1 -P 2222）</p>
<p>6.安装你需要的各种软件，对于我是 RVM, ruby, rails , mysql, redis…</p>
<p>7.sudo poweroff 关闭虚拟机</p>
<p>8.vagrant package 把虚拟机打包成box</p>
<p>9.all done！！！ 分发你的box吧</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/vagrant/">vagrant</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/06/05/使用vagrant统一开发环境/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/01/05/一个事件驱动的图片爬虫/"><span>一个事件驱动的图片爬虫</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/01/05/一个事件驱动的图片爬虫/" rel="bookmark">
        <time class="entry-date published" datetime="2016-01-05T01:43:43.000Z">
          2016-01-05
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h4 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h4><ol>
<li><p>无聊的时候会翻出去看看国外的漫画，然而一页一页加载总是会很慢，偶尔还需要多刷新几次才能显示出来，非常影响体验。于是就写了个脚本去抓某一个漫画下所有的图片，这样跑一遍脚本，就能在本地看图片了。</p>
</li>
<li><p>为了偷懒，第一个版本用的单线程模型，几百张图片串行请求，真的慢。</p>
</li>
<li><p>实际工作中一直没什么机会用到异步IO，正好拿来练练手。</p>
</li>
</ol>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>并发的下载图片，有多线程和事件驱动两套方案。</p>
<p>多线程的实现方式，例如一部漫画有300张图，我不可能开300个Thread，系统受不了。比较实际的做法是使用一个容量为N的ThreadPool，那么，同时就只能发出N个请求，然后所有线程Block等待，其实效率也不高</p>
<p>然而事件驱动的方式就不一样了，我可以一口气把所有请求发出去，当有请求完成时，就调用事先定义的回调Handle，实现了300张图片的并行下载。</p>
<p>先上图看看效果</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4073552-b7ed0d072353aa03.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>从图中就可以看出，所有的请求都发出去之后，才陆续有响应结果乱序到达。这就是典型的异步IO的情景。</p>
<h4 id="基于EventMachine的异步图片爬虫"><a href="#基于EventMachine的异步图片爬虫" class="headerlink" title="基于EventMachine的异步图片爬虫"></a>基于EventMachine的异步图片爬虫</h4><p>EventMachine是ruby社区知名的事件驱动库，类似于Netty、NodeJS</p>
<p>通过 EM.run{}就可以开始一个<a href="http://www.ruanyifeng.com/blog/2013/10/event_loop.html" target="_blank" rel="noopener">事件循环</a></p>
<p>以下是关键代码</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#img_info = [&#123;file_name: '1.jpg', url:'xxx'&#125;...]</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getImg</span><span class="params">(img_info)</span></span></span><br><span class="line">  EM.run&#123; ＃开启事件循环</span><br><span class="line">    multi = EventMachine::MultiRequest.new ＃request容器</span><br><span class="line">    @img_info_copy = img_info.dup</span><br><span class="line">    img_info.each <span class="keyword">do</span> <span class="params">|info|</span></span><br><span class="line">      file_name = File.join(@dir, info[<span class="symbol">:file_name</span>])</span><br><span class="line">      <span class="keyword">if</span> FileTest::exist?(file_name)</span><br><span class="line">        @img_info_copy.delete(info)</span><br><span class="line">        puts <span class="string">"<span class="subst">#&#123;file_name&#125;</span> skip"</span>.blue</span><br><span class="line">        <span class="keyword">next</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      puts <span class="string">"<span class="subst">#&#123;file_name&#125;</span> start"</span>.green</span><br><span class="line">      req = EventMachine::HttpRequest.new(info[<span class="symbol">:url</span>]).get ＃创建request</span><br><span class="line">      multi.add <span class="string">"<span class="subst">#&#123;file_name&#125;</span>"</span>,req</span><br><span class="line">      req.callback &#123; ＃成功回调</span><br><span class="line">        File.open(file_name, <span class="string">'w'</span>) &#123; <span class="params">|file|</span> file.write(req.response) &#125;</span><br><span class="line">        @img_info_copy.delete(info)</span><br><span class="line">        puts <span class="string">"<span class="subst">#&#123;file_name&#125;</span> done"</span>.green</span><br><span class="line">      &#125;</span><br><span class="line">      req.errback &#123; ＃失败回调</span><br><span class="line">        puts <span class="string">"<span class="subst">#&#123;file_name&#125;</span> fail"</span>.red</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    multi.callback <span class="keyword">do</span> ＃所有request都完成后的回调</span><br><span class="line">      <span class="keyword">if</span> @img_info_copy.size == <span class="number">0</span> ＃如果没有图片下载失败</span><br><span class="line">        EM.stop</span><br><span class="line">      <span class="keyword">else</span> ＃递归调用，重新下载的图片</span><br><span class="line">        puts <span class="string">"Total fails: <span class="subst">#&#123;@img_info_copy.size&#125;</span>, solving..."</span>.red</span><br><span class="line">        getImg @img_info_copy.dup</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h4 id="遇到的小坑"><a href="#遇到的小坑" class="headerlink" title="遇到的小坑"></a>遇到的小坑</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EM.run &#123;&#125;之后，主线程就block了，所有写在它后面的代码都不执行</span><br></pre></td></tr></table></figure>
<h4 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h4><p>通过这次的优化，下载一部两三百页漫画的时间从之前单线程版本的二十多分钟，变成了现在的两分钟左右！</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/异步IO/">异步IO</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2016/01/05/一个事件驱动的图片爬虫/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>




<nav class="pagination">
  
  <a href="/" class="pagination-prev">上一页</a>
  
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-113488010-1', 'auto');
    ga('send', 'pageview');

</script>

  </div>
</div>
</body>
</html>